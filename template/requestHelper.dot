const fs = require('fs')
const toJsonSchema = require('to-json-schema');


class requestHelper {
    constructor() {
        // Write your constructor here, if you need 
        this.waitFor = (ms) => new Promise(r => setTimeout(r, ms))
    }
    
    getParam(arg) {
        let data = Object.assign({}, arg)
        delete data.attachment
        delete data.response
        this.waitFor(50)
        return data
    }

    getAttach(arg) {
        let data = {}
        if(arg.hasOwnProperty('attachment')) {
            data = Object.assign({}, arg.attachment)
        }
        this.waitFor(50)
        return data
    }

    getExpectFunc(arg) {
        let expect
        arg.forEach((data) => {
            if (typeof data == "function") 
                expect = data
        })
        this.waitFor(50)
        return expect
    }

    getFile(data) {
        let file
        let name

        let path = data.split('/')
        name = path[path.length-1]
        file = fs.readFileSync(data)
       
        return [file, name]
    }

    getSchema(json_responses, cases, strCase) {
        const options = {
            objects: {
                postProcessFnc: (schema, obj, defaultFnc) => ({...defaultFnc(schema, obj), required: Object.getOwnPropertyNames(obj)})
            }
        }

        if(cases.includes(strCase)) cases = strCase
        if (json_responses.hasOwnProperty(cases)) {
            return toJsonSchema(json_responses[cases], options)
        } else {
            throw new Error('JSON Schema: '+cases+', does not exist!')
        }
        
    }

    objectMapping(obj, map) {
        if (map.length > 0)
            // Define desired object
            Object.keys(map).forEach((key) => {
                Object.keys(obj).forEach((keyObj) => {
                    if(typeof obj[keyObj] != "object") {
                        if(keyObj == key) {
                            obj[key] = map[key]
                        }
                    } else {
                        if(keyObj == key) {
                            obj[key] = map[key]
                        }
                        if(Array.isArray(obj[keyObj])) {
                            obj[keyObj].forEach((objArr) => {
                                if (typeof Object.values(objArr)[0] != "object") {
                                    if (Object.keys(objArr)[0] == key)
                                        objArr[key] = map[key]
                                } else {
                                    (Object.values(objArr)[0]).forEach((dobjArr) => {
                                        if (typeof Object.values(dobjArr)[0] != "object") {
                                            if (Object.keys(dobjArr)[0] == key)
                                                dobjArr[key] = map[key]
                                    }
                                    })
                                }
                            })
                        } else {
                            if (typeof Object.values(obj[keyObj])[0] != "object") {
                                if (Object.keys(obj[keyObj])[0] == key)
                                    obj[keyObj][key] = map[key]
                            } else {
                                (Object.values(obj[keyObj])[0]).forEach((dobjArr) => {
                                    if (typeof Object.values(dobjArr)[0] != "object") {
                                        if (Object.keys(dobjArr)[0] == key)
                                            dobjArr[key] = map[key]
                                    }
                                })
                            }
                        }
                    }
                })
            })
        this.waitFor(100)
    }
}

module.exports = requestHelper